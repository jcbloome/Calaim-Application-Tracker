
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Check for existence of the user's UID in either admin or super_admin roles.
      // A super_admin is implicitly an admin.
      return isSignedIn() && (
        exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) ||
        exists(/databases/$(database)/documents/roles_super_admin/$(request.auth.uid))
      );
    }
    
    function isSuperAdmin() {
       return isSignedIn() && exists(/databases/$(database)/documents/roles_super_admin/$(request.auth.uid));
    }

    // --- USER-SPECIFIC RULES ---
    match /users/{userId} {
      // Admins can manage any user profile. Users can only manage their own.
      allow read, write: if isOwner(userId) || isAdmin();

      // Application subcollection rules
      match /applications/{applicationId} {
        // Users can manage their own applications. Admins can manage any application.
        allow read, write, delete: if isOwner(userId) || isAdmin();
        
        // Staff Trackers sub-subcollection rules
        match /staffTrackers/{trackerId} {
            // Only admins can read/write internal staff trackers.
            allow read, list, write: if isAdmin();
        }
      }
    }
    
    // --- COLLECTION GROUP RULES ---
    
    // This rule is CRITICAL for the admin dashboard.
    // It allows any user identified as an admin to list all applications across all users.
    match /{path=**}/applications/{applicationId} {
      allow list: if isAdmin();
    }

    // --- GLOBAL/SYSTEM RULES ---

    // 1. Role Verification: 
    // Allows any signed-in user to check their OWN admin status.
    // This is secure because they can only read documents where the {userId} matches their own UID.
    // The `list` permission is denied, so they cannot enumerate all admins.
    match /roles_admin/{userId} {
      allow get: if isOwner(userId);
      allow list, write, create, delete: if false; 
    }
    
    match /roles_super_admin/{userId} {
      allow get: if isOwner(userId);
      allow list, write, create, delete: if false; 
    }
    
    // 2. System Settings
    // Only Super Admins can write to system settings.
    // Regular admins can read them.
    match /system_settings/{docId} {
        allow read: if isAdmin();
        allow write: if isSuperAdmin();
    }
    
    // 3. Test Collection
    // Allow any signed-in user to perform all operations on the test collection.
    match /test_writes/{docId} {
        allow write: if isSignedIn();
    }
  }
}
