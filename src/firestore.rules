
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy:
     * This ruleset enforces a strict user-ownership model. All user-generated data
     * is stored under `/users/{userId}`. This ensures data isolation by default.
     * Administrative roles (`/roles_admin`, `/roles_super_admin`) grant privileged
     * access across all user data.
     *
     * Key Security Decisions:
     * - Default Deny: All paths are closed by default. Access is granted explicitly.
     * - User Data Isolation: Access to `/users/{userId}` data is based on matching
     *   the authenticated user's UID with the `userId` in the path.
     * - No User Enumeration (for non-admins): Listing top-level collections is
     *   forbidden for regular users to prevent enumeration of all users or admins.
     * - Admin Privileges: The existence of a document in `/roles_admin` grants
     *   broad read/write access. The `/roles_super_admin` grants universal access,
     *   including the ability to list all users and manage roles.
     * - Role Management Security: Roles can only be managed by super admins.
     *
     * Structural Separation of Rules:
     * To comply with Firestore's rule evaluation, collection-level rules (like `list`)
     * are defined in their own `match` blocks, separate from document-level rules
     * (`get`, `write`, `delete`). This is critical for query-based rules to work correctly.
     */

    // =================================
    //         Helper Functions
    // =================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    function isSuperAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_super_admin/$(request.auth.uid));
    }

    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || isAdmin() || isSuperAdmin();
    }
    
    function isExistingOwnerOrAdmin(userId) {
      return isOwnerOrAdmin(userId) && resource != null;
    }

    function hasValidApplicationDataOnCreate(userId) {
      return request.resource.data.userId == userId;
    }

    function hasValidApplicationDataOnUpdate() {
      return request.resource.data.userId == resource.data.userId;
    }

    function hasValidSubcollectionDataOnCreate(applicationId) {
      return request.resource.data.applicationId == applicationId;
    }

    function hasValidSubcollectionDataOnUpdate() {
      return request.resource.data.applicationId == resource.data.applicationId;
    }

    // =====================================================================
    //         COLLECTION-LEVEL & COLLECTION GROUP RULES (FOR QUERIES)
    // =====================================================================
    
    // This allows admins and super admins to query across all users' applications.
    match /{path=**}/applications/{applicationId} {
      allow read: if isSuperAdmin() || isAdmin();
    }
    
    // Rules for LIST operations on top-level collections must be separate.
    match /users/{document=**} {
      allow list: if isSuperAdmin();
    }
    match /roles_admin/{document=**} {
      allow list: if isSuperAdmin();
    }
    match /roles_super_admin/{document=**} {
      allow list: if isSuperAdmin() || isSignedIn();
    }

    // =====================================================================
    //         DOCUMENT-SPECIFIC RULES (GET, CREATE, UPDATE, DELETE)
    // =====================================================================

    match /users/{userId} {
      allow get: if isOwnerOrAdmin(userId);
      allow create, update: if isOwner(userId);
      allow delete: if isOwnerOrAdmin(userId);

      match /applications/{applicationId} {
        allow get, list: if isOwnerOrAdmin(userId);
        allow create: if isOwnerOrAdmin(userId) && hasValidApplicationDataOnCreate(userId);
        allow update: if isExistingOwnerOrAdmin(userId) && hasValidApplicationDataOnUpdate();
        allow delete: if isExistingOwnerOrAdmin(userId);

        match /{subcollection}/{docId} {
          allow get, list: if isOwnerOrAdmin(userId);
          allow create: if isOwnerOrAdmin(userId) && hasValidSubcollectionDataOnCreate(applicationId);
          allow update: if isExistingOwnerOrAdmin(userId) && hasValidSubcollectionDataOnUpdate();
          allow delete: if isExistingOwnerOrAdmin(userId);
        }
      }
    }

    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow write, delete: if isSuperAdmin();
    }
    
    match /roles_super_admin/{userId} {
      allow get: if isSignedIn();
      // Temporarily allow any signed-in user to create their own super_admin role
      allow write: if isSuperAdmin() || request.auth.uid == userId;
      allow delete: if isSuperAdmin();
    }
  }
}
